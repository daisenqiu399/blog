---
updateTime: "2024-09-08 00:48"
desc: "å‰ç«¯é¢è¯•é«˜é¢‘æ‰‹å†™é¢˜ä¸Žåœºæ™¯é¢˜, ç›®å‰æ”¶å½•é˜²æŠ–ã€Promise.allã€å¹¶å‘è¯·æ±‚æŽ§åˆ¶..."
tags: "å…«è‚¡"
outline: 3
---

## æ‰‹å†™é¢˜

### å®žçŽ° Promise.all

**ðŸŽ¯ é¢˜ç›®æè¿°**

Promise.all() é™æ€æ–¹æ³•æŽ¥å—ä¸€ä¸ª Promise å¯è¿­ä»£å¯¹è±¡ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›žä¸€ä¸ª Promiseã€‚

- å½“æ‰€æœ‰è¾“å…¥çš„ Promise éƒ½è¢«å…‘çŽ°æ—¶ï¼Œè¿”å›žçš„ Promise ä¹Ÿå°†è¢«å…‘çŽ°ï¼ˆå³ä½¿ä¼ å…¥çš„æ˜¯ä¸€ä¸ªç©ºçš„å¯è¿­ä»£å¯¹è±¡ï¼‰ï¼Œå¹¶è¿”å›žä¸€ä¸ªåŒ…å«æ‰€æœ‰å…‘çŽ°å€¼çš„æ•°ç»„ã€‚
- å¦‚æžœè¾“å…¥çš„ä»»ä½• Promise è¢«æ‹’ç»ï¼Œåˆ™è¿”å›žçš„ Promise å°†è¢«æ‹’ç»ï¼Œå¹¶å¸¦æœ‰ç¬¬ä¸€ä¸ªè¢«æ‹’ç»çš„åŽŸå› ã€‚

**ðŸ“š ç¤ºä¾‹ä»£ç **

```js
const promiseAll = (proms) => {
  return new Promise((resolve, reject) => {
    if (proms == null || typeof proms[Symbol.iterator] !== "function") {
      throw new TypeError("proms must be an iterable");
    }
    proms = [...proms];

    if (proms.length === 0) resolve([]);
    let count = 0;
    const result = [];
    proms.forEach((prom, index) => {
      Promise.resolve(prom)
        .then((res) => {
          result[index] = res;
          if (++count === proms.length) resolve(result);
        })
        .catch(reject);
    });
  });
};
```

### é˜²æŠ–

**ðŸŽ¯ é¢˜ç›®æè¿°**

å®žçŽ°ä¸€ä¸ªé˜²æŠ–å‡½æ•°ï¼šåœ¨ä¸€å®šæ—¶é—´å†…æŸä¸ªäº‹ä»¶é¢‘ç¹è§¦å‘æ—¶ï¼Œå›žè°ƒå‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ã€‚

- å‡½æ•°æŽ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å›žè°ƒå‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç­‰å¾…æ—¶é—´ã€‚
- è¿”å›žä¸€ä¸ªæ–°å‡½æ•°ï¼Œæ–°å‡½æ•°åœ¨ç­‰å¾…æ—¶é—´å†…è¢«å¤šæ¬¡è°ƒç”¨æ—¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚

**ðŸ“š ç¤ºä¾‹ä»£ç **

éœ€è¦æ³¨æ„çš„ç»†èŠ‚ï¼š
- **`setTimeout` å›žè°ƒå‡½æ•°æ‰§è¡Œæ—¶, `this` æŒ‡å‘ `window`**ï¼Œéœ€è¦è®°å½•åŽŸå‡½æ•°çš„ `this`ã€‚
- ä¸ºäº†æ”¯æŒå›žè°ƒå‡½æ•°çš„å‚æ•°ä¼ é€’ï¼Œä½¿ç”¨ `...args` èŽ·å–å‚æ•°å¹¶åˆ©ç”¨ `apply` ä¼ é€’å‚æ•°ã€‚

::: code-group

```js
const debounce = (fn, wait) => {
  let timer;
  return function (...args) {
    let context = this;
    clearTimeout(timer);
    timer = setTimeout(() => {
      fn.apply(context, args);
    }, wait);
  };
};
```

```ts
function debounce<T extends (...args: any[]) => void>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let timeout: ReturnType<typeof setTimeout> | undefined;

  return function (this: ThisParameterType<T>, ...args: Parameters<T>): void {
    let context = this;
    clearTimeout(timeout!);
    timeout = setTimeout(() => {
      func.apply(this, args);
    }, wait);
  };
}
```

```html [å…·ä½“åº”ç”¨åœºæ™¯]
<body>
  <button onclick="handleClick()">Click</button>
</body>

<script>
  const debounce = (fn, wait) => {
    let timer;
    return function (...args) {
      let context = this;
      clearTimeout(timer);
      timer = setTimeout(() => {
        fn.apply(this, args);
      }, wait);
    };
  };
  /*
  åº”ç”¨åœºæ™¯ä¸¾ä¾‹ï¼š
    1. æŸäº›æŸ¥è¯¢æ•°æ®çš„æŒ‰é’®å¤šæ¬¡ç‚¹å‡»æ—¶ï¼Œåªå‘é€ä¸€æ¬¡è¯·æ±‚
    2. scroll / input / resize ç­‰äº‹ä»¶é¢‘ç¹è§¦å‘æ—¶ï¼Œå‡å°‘å›žè°ƒå‡½æ•°çš„æ‰§è¡Œæ¬¡æ•°
  */
  const handleClick = debounce(() => {
    console.log("click");
  }, 1000);
</script>
```

:::

**å‡çº§ç‰ˆï¼šæ”¯æŒç«‹å³æ‰§è¡Œ**

::: warning ðŸš§ TODO... 

:::

## åœºæ™¯é¢˜

### å¹¶å‘è¯·æ±‚æŽ§åˆ¶

å®žçŽ°ä¸€ä¸ª `PromisePool` ç±»ï¼Œé™åˆ¶å¹¶å‘è¯·æ±‚çš„æ•°é‡ã€‚

```js
class PromisePool {
  constructor(capacity) {
    this.capacity = capacity;
    this.tasks = [];
    this.running = 0;
  }

  add(fn) {
    return new Promise((resolve, reject) => {
      this.tasks.push({
        fn,
        resolve,
        reject,
      });
      this._run();
    });
  }

  _run() {
    while (this.tasks.length && this.running < this.capacity) {
      const { fn, resolve, reject } = this.tasks.shift();
      this.running++;
      fn()
        .then(resolve, reject)
        .finally(() => {
          this.running--;
          this._run();
        });
    }
  }
}

const sleep = (time) => new Promise((resolve) => setTimeout(resolve, time));
const addTask = (time, str) => {
  pool
    .add(() => sleep(time))
    .then(() => {
      console.log(str);
    });
};
const pool = new PromisePool(2);
addTask(10000, "1");
addTask(5000, "2");
addTask(3000, "3");
addTask(4000, "4");
addTask(5000, "5");
// 2 3 1 4 5
```
