---
updateTime: "2024-09-08 00:48"
desc: "å‰ç«¯é¢è¯•é«˜é¢‘æ‰‹å†™é¢˜ä¸åœºæ™¯é¢˜, ç›®å‰æ”¶å½•é˜²æŠ–ã€Promise.allã€å¹¶å‘è¯·æ±‚æ§åˆ¶..."
tags: "å…«è‚¡"
outline: 3
---

## æ‰‹å†™é¢˜

### å®ç° Promise.all

**ğŸ¯ é¢˜ç›®æè¿°**

Promise.all() é™æ€æ–¹æ³•æ¥å—ä¸€ä¸ª Promise å¯è¿­ä»£å¯¹è±¡ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸ª Promiseã€‚

- å½“æ‰€æœ‰è¾“å…¥çš„ Promise éƒ½è¢«å…‘ç°æ—¶ï¼Œè¿”å›çš„ Promise ä¹Ÿå°†è¢«å…‘ç°ï¼ˆå³ä½¿ä¼ å…¥çš„æ˜¯ä¸€ä¸ªç©ºçš„å¯è¿­ä»£å¯¹è±¡ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰å…‘ç°å€¼çš„æ•°ç»„ã€‚
- å¦‚æœè¾“å…¥çš„ä»»ä½• Promise è¢«æ‹’ç»ï¼Œåˆ™è¿”å›çš„ Promise å°†è¢«æ‹’ç»ï¼Œå¹¶å¸¦æœ‰ç¬¬ä¸€ä¸ªè¢«æ‹’ç»çš„åŸå› ã€‚

**ğŸ“š ç¤ºä¾‹ä»£ç **

```js
const promiseAll = (proms) => {
  return new Promise((resolve, reject) => {
    if (proms == null || typeof proms[Symbol.iterator] !== "function") {
      throw new TypeError("proms must be an iterable");
    }
    proms = [...proms];

    if (proms.length === 0) resolve([]);
    let count = 0;
    const result = [];
    proms.forEach((prom, index) => {
      Promise.resolve(prom)
        .then((res) => {
          result[index] = res;
          if (++count === proms.length) resolve(result);
        })
        .catch(reject);
    });
  });
};
```

### é˜²æŠ–

**ğŸ¯ é¢˜ç›®æè¿°**

å®ç°ä¸€ä¸ªé˜²æŠ–å‡½æ•°ï¼š**äº‹ä»¶è§¦å‘åç­‰å¾…ä¸€æ®µæ—¶é—´**å†æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå¦‚æœåœ¨ç­‰å¾…æœŸé—´å†…å†æ¬¡è§¦å‘äº†åŒä¸€äº‹ä»¶ï¼Œåˆ™é‡æ–°è®¡æ—¶ï¼Œä»¥é¿å…å›è°ƒå‡½æ•°çš„å¤šæ¬¡æ‰§è¡Œã€‚

**ğŸ“š ç¤ºä¾‹ä»£ç **

éœ€è¦æ³¨æ„çš„ç»†èŠ‚ï¼š

- **`setTimeout` å›è°ƒå‡½æ•°æ‰§è¡Œæ—¶, `this` æŒ‡å‘ `window`**ï¼Œéœ€è¦è®°å½•åŸå‡½æ•°çš„ `this`ã€‚
- ä¸ºäº†æ”¯æŒå›è°ƒå‡½æ•°çš„å‚æ•°ä¼ é€’ï¼Œä½¿ç”¨ `...args` è·å–å‚æ•°å¹¶åˆ©ç”¨ `apply` ä¼ é€’å‚æ•°ã€‚

::: code-group

```js
const debounce = (fn, wait) => {
  let timer;
  return function (...args) {
    const context = this;
    clearTimeout(timer);
    timer = setTimeout(() => {
      fn.apply(context, args);
    }, wait);
  };
};
```

```ts
function debounce<T extends (...args: any[]) => void>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let timeout: ReturnType<typeof setTimeout> | undefined;

  return function (...args: Parameters<T>): void {
    const context = this;
    clearTimeout(timeout!);
    timeout = setTimeout(() => {
      func.apply(this, args);
    }, wait);
  };
}
```

```html [ä½¿ç”¨ç¤ºä¾‹]
<body>
  <button onclick="handleClick()">Click</button>
</body>

<script>
  const debounce = (fn, wait) => {
    let timer;
    return function (...args) {
      const context = this;
      clearTimeout(timer);
      timer = setTimeout(() => {
        fn.apply(this, args);
      }, wait);
    };
  };
  const handleClick = debounce(() => {
    console.log("click");
  }, 1000);
</script>
```

:::

::: details Proï¼šæ”¯æŒç«‹å³æ‰§è¡Œçš„é˜²æŠ–å‡½æ•° â°

æœ‰çš„æ—¶å€™æˆ‘ä»¬å¸Œæœ›åœ¨äº‹ä»¶è§¦å‘æ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡å›è°ƒå‡½æ•°ï¼Œç„¶ååœ¨ç­‰å¾…æ—¶é—´å†…ä¸å†æ‰§è¡Œï¼Œä¾‹å¦‚ç‚¹å‡»æŒ‰é’®åç«‹å³å‘é€è¯·æ±‚ã€‚

```js
// æ­¤å¤„ç¬”è€…å·æ‡’åªç»™å‡ºäº† js ç‰ˆæœ¬çš„å®ç°ã€‚
const debounce = (fn, wait = 0, immediate = false) => {
  let timer;
  return function (...args) {
    const context = this;
    clearTimeout(timer);

    if (immediate) {
      const callNow = !timer;
      timer = setTimeout(() => (timer = null), wait);
      if (callNow) fn.apply(context, args);
    } else {
      timer = setTimeout(() => {
        fn.apply(context, args);
      }, wait);
    }
  };
};
```

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨å¹¿æ³›ä½¿ç”¨çš„ lodash åº“ä¸­ï¼Œ`_.debounce` å‡½æ•°è¿˜æ”¯æŒæ›´åŠ ä¸°å¯Œçš„é…ç½®ï¼Œä¾‹å¦‚ `leading` å’Œ `trailing` å‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºæ˜¯å¦åœ¨ç­‰å¾…æ—¶é—´å¼€å§‹æ—¶ç«‹å³æ‰§è¡Œå’Œç»“æŸæ—¶æ‰§è¡Œã€‚æ„Ÿå…´è¶£è¯·æŸ¥é˜… lodash æ–‡æ¡£ã€‚

:::

**ğŸ¨ åº”ç”¨åœºæ™¯**

- è¾“å…¥æ¡†å±•ç¤ºæœç´¢å»ºè®®ï¼šå½“ç”¨æˆ·åœ¨è¾“å…¥æ¡†ä¸­è¿ç»­è¾“å…¥æ—¶ï¼Œåªåœ¨ç”¨æˆ·åœæ­¢è¾“å…¥åå‘é€è¯·æ±‚ã€‚
- çª—å£å¤§å°å˜åŒ–ï¼ˆ`resize`ï¼‰äº‹ä»¶ï¼šå½“ç”¨æˆ·è°ƒæ•´çª—å£å¤§å°æ—¶ï¼Œåªåœ¨åœæ­¢è°ƒæ•´åæ‰§è¡Œå¸ƒå±€è®¡ç®—ï¼Œé¿å…é¡µé¢æŠ–åŠ¨ã€‚

---

### èŠ‚æµ

**ğŸ¯ é¢˜ç›®æè¿°**

å®ç°ä¸€ä¸ªèŠ‚æµå‡½æ•°ï¼š**åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œäº‹ä»¶å¤šæ¬¡è§¦å‘åªæ‰§è¡Œä¸€æ¬¡å›è°ƒå‡½æ•°**ã€‚ä¸è®ºäº‹ä»¶è§¦å‘å¤šé¢‘ç¹ï¼Œéƒ½ä¼šæŒ‰ç…§å›ºå®šçš„æ—¶é—´é—´éš”æ‰§è¡Œã€‚

**ğŸ“š ç¤ºä¾‹ä»£ç **

:::code-group

```ts [æ—¶é—´æˆ³ç‰ˆæœ¬]
const throttle = (fn: Function, wait = 0) => {
  let lastTime = 0;

  return function (...args: any[]) {
    const now = Date.now();
    if (now - lastTime >= wait) {
      fn.apply(this, args);
      lastTime = now;
    }
  };
};
```

```ts [setTimeout ç‰ˆæœ¬]
const throttle = (fn: Function, wait = 0) => {
  let isThrottle = false;

  return function (...args: any[]) {
    if (!isThrottle) {
      isThrottle = true;
      fn.apply(this, args);
      setTimeout(() => (isThrottle = false), wait);
    }
  };
};
```

```html [ä½¿ç”¨ç¤ºä¾‹]
<body>
  <div style="height: 200vh; background-color: lightblue"></div>
</body>

<script>
  const throttle = (fn, wait) => {
    // å®ç°ç•¥...
  };

  const handleScroll = (e) => {
    console.log(e.target.scrollingElement.scrollTop);
  };

  const throttleHandleScroll = throttle(handleScroll, 1000);
  document.addEventListener("scroll", throttleHandleScroll);
</script>
```

:::

**ğŸ¨ åº”ç”¨åœºæ™¯**

- å›¾ç‰‡æ»šåŠ¨åŠ è½½ï¼šé¡µé¢æ»šåŠ¨æ—¶ï¼Œä¸æ–­æ‰§è¡Œå›¾ç‰‡åŠ è½½å‡½æ•°ã€‚ï¼ˆä¸ä½¿ç”¨é˜²æŠ–æ˜¯å› ä¸ºä¸å¯èƒ½ç­‰åˆ°ç”¨æˆ·åœæ­¢æ»šåŠ¨æ‰åŠ è½½å›¾ç‰‡å§ï¼ï¼‰
- æ‹–æ‹½ï¼ˆ`touchmove`ï¼‰äº‹ä»¶ï¼šæ‹–æ‹½å…ƒç´ æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­ä¸æ–­è®¡ç®—å…ƒç´ ä½ç½®ï¼Œä½†ä¸å¸Œæœ›è®¡ç®—è¿‡äºé¢‘ç¹ã€‚

### æ·±æ‹·è´

**ğŸ¯ é¢˜ç›®æè¿°**

å®ç°ä¸€ä¸ªæ·±æ‹·è´å‡½æ•°ï¼Œæ”¯æŒæ‹·è´å¸¸è§çš„æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚å¯¹è±¡ã€æ•°ç»„ã€å‡½æ•°ã€æ­£åˆ™ã€æ—¥æœŸç­‰ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ­£å¸¸å¤„ç†å¾ªç¯å¼•ç”¨ã€‚

**ğŸ“š ç¤ºä¾‹ä»£ç **

- ä½¿ç”¨ `WeakMap` ä½œä¸ºå“ˆå¸Œè¡¨ï¼Œè®°å½•å·²ç»æ‹·è´è¿‡çš„å¯¹è±¡ï¼Œé¿å…å¾ªç¯å¼•ç”¨å¯¼è‡´çš„æ ˆæº¢å‡ºã€‚
- å¯¹äºç‰¹æ®Šçš„æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚ `Date`ã€`RegExp`ï¼Œç›´æ¥åˆ›å»ºæ–°çš„å®ä¾‹ã€‚

:::code-group

```ts [ä¾¿æ·ç‰ˆæœ¬]
function deepCloneEasy<T>(obj: T): T {
  // ä¸èƒ½å¤„ç†å‡½æ•°ã€æ­£åˆ™ã€undefinedã€å¾ªç¯å¼•ç”¨
  return JSON.parse(JSON.stringify(obj));
}

// é¡ºä¾¿å¤ä¹ ä¸€ä¸‹æµ…æ‹·è´å§ï¼
// 1. Object.assign
// 2. æ‰©å±•è¿ç®—ç¬¦ ...
```

```ts [å®Œæ•´ç‰ˆæœ¬]
function deepClone<T>(obj: T, hashMap = new WeakMap()): T {
  if (obj === null || typeof obj !== "object") return obj;
  if (obj instanceof Date) return new Date(obj) as any;
  if (obj instanceof RegExp) return new RegExp(obj) as any;

  if (hashMap.has(obj)) return hashMap.get(obj);

  if (Array.isArray(obj)) {
    const copy: any[] = [];
    hashMap.set(obj, copy);
    obj.forEach((item) => copy.push(deepClone(item, hashMap)));
    return copy as any;
  } else {
    const copy: Record<string, any> = {};
    hashMap.set(obj, copy);
    Object.entries(obj).forEach(
      ([key, value]) => (copy[key] = deepClone(value, hashMap))
    );
    return copy as any;
  }

  // è¯¥ä»£ç å¹¶æ²¡æœ‰è€ƒè™‘ä¼ å…¥å‚æ•°ä¸º Mapã€Set ç­‰ç‰¹æ®Šå¯¹è±¡çš„æƒ…å†µ
  // ä½¿ç”¨ obj instanceof Map ç„¶ååšç±»ä¼¼å¤„ç†å³å¯
}
```

:::

### å‡½æ•°æŸ¯é‡ŒåŒ–

**ğŸ¯ é¢˜ç›®æè¿°**

å®ç°ä¸€ä¸ªæŸ¯é‡ŒåŒ–å‡½æ•°ï¼Œæ”¯æŒå¤šå‚æ•°ä¼ é€’ï¼Œä¾‹å¦‚ `curry(fn)(a)(b)(c)`ã€‚

- æŸ¯é‡ŒåŒ–å°†ä¸€ä¸ªå¤šå‚æ•°å‡½æ•°è½¬æ¢ä¸ºä¸€ç³»åˆ—å‡½æ•°ï¼Œè¿™äº›å‡½æ•°æ¯æ¬¡æ¥æ”¶ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ï¼Œç›´åˆ°æ‰€æœ‰å‚æ•°éƒ½è¢«æä¾›ä¸ºæ­¢ã€‚
- æŸ¯é‡ŒåŒ–çš„ä¸»è¦ä½œç”¨æ˜¯**å‚æ•°å¤ç”¨**å’Œ**å»¶è¿Ÿæ‰§è¡Œ**ï¼Œä¹‹å‰ä¼ é€’çš„å‚æ•°å¯ä»¥åœ¨åç»­è°ƒç”¨ä¸­å¤ç”¨ã€‚

**ğŸ“š ç¤ºä¾‹ä»£ç **

```js
const curry = (fn, ...args) => {
  return args.length >= fn.length
    ? fn(...args)
    : (..._args) => curry(fn, ...args, ..._args);
};

// ã€ä½¿ç”¨ç¤ºä¾‹ã€‘
const saySomething = (name, str) => console.log(`${name} says: ${str}`);
const tomSay = curry(saySomething, "Tom");
tomSay("hello"); // Tom says: hello

// å®ç°add(1)(2)(3)è¾“å‡º6çš„å‡½æ•°
const add = (a, b, c) => a + b + c;
const addCurry = curry(add);
console.log(addCurry(1)(2)(3)); // 6
```

## åœºæ™¯é¢˜

### å¹¶å‘è¯·æ±‚æ§åˆ¶

å®ç°ä¸€ä¸ª `PromisePool` ç±»ï¼Œé™åˆ¶å¹¶å‘è¯·æ±‚çš„æ•°é‡ã€‚

```js
class PromisePool {
  constructor(capacity) {
    this.capacity = capacity;
    this.tasks = [];
    this.running = 0;
  }

  add(fn) {
    return new Promise((resolve, reject) => {
      this.tasks.push({
        fn,
        resolve,
        reject,
      });
      this._run();
    });
  }

  _run() {
    while (this.tasks.length && this.running < this.capacity) {
      const { fn, resolve, reject } = this.tasks.shift();
      this.running++;
      fn()
        .then(resolve, reject)
        .finally(() => {
          this.running--;
          this._run();
        });
    }
  }
}

const sleep = (time) => new Promise((resolve) => setTimeout(resolve, time));
const addTask = (time, str) => {
  pool
    .add(() => sleep(time))
    .then(() => {
      console.log(str);
    });
};
const pool = new PromisePool(2);
addTask(10000, "1");
addTask(5000, "2");
addTask(3000, "3");
addTask(4000, "4");
addTask(5000, "5");
// 2 3 1 4 5
```
