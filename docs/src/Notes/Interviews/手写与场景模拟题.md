---
updateTime: "2024-09-08 00:48"
desc: "å‰ç«¯é¢è¯•é«˜é¢‘æ‰‹å†™é¢˜ä¸Žåœºæ™¯é¢˜, ç›®å‰æ”¶å½•é˜²æŠ–ã€Promise.allã€å¹¶å‘è¯·æ±‚æŽ§åˆ¶..."
tags: "å…«è‚¡"
outline: 3
---

## æ‰‹å†™é¢˜

### å®žçŽ° Promise.all

**ðŸŽ¯ é¢˜ç›®æè¿°**

Promise.all() é™æ€æ–¹æ³•æŽ¥å—ä¸€ä¸ª Promise å¯è¿­ä»£å¯¹è±¡ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›žä¸€ä¸ª Promiseã€‚

- å½“æ‰€æœ‰è¾“å…¥çš„ Promise éƒ½è¢«å…‘çŽ°æ—¶ï¼Œè¿”å›žçš„ Promise ä¹Ÿå°†è¢«å…‘çŽ°ï¼ˆå³ä½¿ä¼ å…¥çš„æ˜¯ä¸€ä¸ªç©ºçš„å¯è¿­ä»£å¯¹è±¡ï¼‰ï¼Œå¹¶è¿”å›žä¸€ä¸ªåŒ…å«æ‰€æœ‰å…‘çŽ°å€¼çš„æ•°ç»„ã€‚
- å¦‚æžœè¾“å…¥çš„ä»»ä½• Promise è¢«æ‹’ç»ï¼Œåˆ™è¿”å›žçš„ Promise å°†è¢«æ‹’ç»ï¼Œå¹¶å¸¦æœ‰ç¬¬ä¸€ä¸ªè¢«æ‹’ç»çš„åŽŸå› ã€‚

**ðŸ“š ç¤ºä¾‹ä»£ç **

```js
const promiseAll = (proms) => {
  return new Promise((resolve, reject) => {
    if (proms == null || typeof proms[Symbol.iterator] !== "function") {
      throw new TypeError("proms must be an iterable");
    }
    proms = [...proms];

    if (proms.length === 0) resolve([]);
    let count = 0;
    const result = [];
    proms.forEach((prom, index) => {
      Promise.resolve(prom)
        .then((res) => {
          result[index] = res;
          if (++count === proms.length) resolve(result);
        })
        .catch(reject);
    });
  });
};
```

### é˜²æŠ–

**ðŸŽ¯ é¢˜ç›®æè¿°**

å®žçŽ°ä¸€ä¸ªé˜²æŠ–å‡½æ•°ï¼š**äº‹ä»¶è§¦å‘åŽç­‰å¾…ä¸€æ®µæ—¶é—´**å†æ‰§è¡Œå›žè°ƒå‡½æ•°ï¼Œå¦‚æžœåœ¨ç­‰å¾…æœŸé—´å†…å†æ¬¡è§¦å‘äº†åŒä¸€äº‹ä»¶ï¼Œåˆ™é‡æ–°è®¡æ—¶ï¼Œä»¥é¿å…å›žè°ƒå‡½æ•°çš„å¤šæ¬¡æ‰§è¡Œã€‚

**ðŸ“š ç¤ºä¾‹ä»£ç **

éœ€è¦æ³¨æ„çš„ç»†èŠ‚ï¼š

- **`setTimeout` å›žè°ƒå‡½æ•°æ‰§è¡Œæ—¶, `this` æŒ‡å‘ `window`**ï¼Œéœ€è¦è®°å½•åŽŸå‡½æ•°çš„ `this`ã€‚
- ä¸ºäº†æ”¯æŒå›žè°ƒå‡½æ•°çš„å‚æ•°ä¼ é€’ï¼Œä½¿ç”¨ `...args` èŽ·å–å‚æ•°å¹¶åˆ©ç”¨ `apply` ä¼ é€’å‚æ•°ã€‚

::: code-group

```js
const debounce = (fn, wait) => {
  let timer;
  return function (...args) {
    const context = this;
    clearTimeout(timer);
    timer = setTimeout(() => {
      fn.apply(context, args);
    }, wait);
  };
};
```

```ts
function debounce<T extends (...args: any[]) => void>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let timeout: ReturnType<typeof setTimeout> | undefined;

  return function (this: ThisParameterType<T>, ...args: Parameters<T>): void {
    const context = this;
    clearTimeout(timeout!);
    timeout = setTimeout(() => {
      func.apply(this, args);
    }, wait);
  };
}
```

```html [ä½¿ç”¨ç¤ºä¾‹]
<body>
  <button onclick="handleClick()">Click</button>
</body>

<script>
  const debounce = (fn, wait) => {
    let timer;
    return function (...args) {
      const context = this;
      clearTimeout(timer);
      timer = setTimeout(() => {
        fn.apply(this, args);
      }, wait);
    };
  };
  const handleClick = debounce(() => {
    console.log("click");
  }, 1000);
</script>
```

:::

::: details Proï¼šæ”¯æŒç«‹å³æ‰§è¡Œçš„é˜²æŠ–å‡½æ•° â°

æœ‰çš„æ—¶å€™æˆ‘ä»¬å¸Œæœ›åœ¨äº‹ä»¶è§¦å‘æ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡å›žè°ƒå‡½æ•°ï¼Œç„¶åŽåœ¨ç­‰å¾…æ—¶é—´å†…ä¸å†æ‰§è¡Œï¼Œä¾‹å¦‚ç‚¹å‡»æŒ‰é’®åŽç«‹å³å‘é€è¯·æ±‚ã€‚

```js
// æ­¤å¤„ç¬”è€…å·æ‡’åªç»™å‡ºäº† js ç‰ˆæœ¬çš„å®žçŽ°ã€‚
const debounce = (fn, wait = 0, immediate = false) => {
  let timer;
  return function (...args) {
    const context = this;
    clearTimeout(timer);

    if (immediate) {
      const callNow = !timer;
      timer = setTimeout(() => (timer = null), wait);
      if (callNow) fn.apply(context, args);
    } else {
      timer = setTimeout(() => {
        fn.apply(context, args);
      }, wait);
    }
  };
};
```

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨å¹¿æ³›ä½¿ç”¨çš„ lodash åº“ä¸­ï¼Œ`_.debounce` å‡½æ•°è¿˜æ”¯æŒæ›´åŠ ä¸°å¯Œçš„é…ç½®ï¼Œä¾‹å¦‚ `leading` å’Œ `trailing` å‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºæ˜¯å¦åœ¨ç­‰å¾…æ—¶é—´å¼€å§‹æ—¶ç«‹å³æ‰§è¡Œå’Œç»“æŸæ—¶æ‰§è¡Œã€‚æ„Ÿå…´è¶£è¯·æŸ¥é˜… lodash æ–‡æ¡£ã€‚

:::

**ðŸŽ¨ åº”ç”¨åœºæ™¯**

- è¾“å…¥æ¡†å±•ç¤ºæœç´¢å»ºè®®ï¼šå½“ç”¨æˆ·åœ¨è¾“å…¥æ¡†ä¸­è¿žç»­è¾“å…¥æ—¶ï¼Œåªåœ¨ç”¨æˆ·åœæ­¢è¾“å…¥åŽå‘é€è¯·æ±‚ã€‚
- çª—å£å¤§å°å˜åŒ–ï¼ˆ`resize`ï¼‰äº‹ä»¶ï¼šå½“ç”¨æˆ·è°ƒæ•´çª—å£å¤§å°æ—¶ï¼Œåªåœ¨åœæ­¢è°ƒæ•´åŽæ‰§è¡Œå¸ƒå±€è®¡ç®—ï¼Œé¿å…é¡µé¢æŠ–åŠ¨ã€‚

---

### èŠ‚æµ

**ðŸŽ¯ é¢˜ç›®æè¿°**

å®žçŽ°ä¸€ä¸ªèŠ‚æµå‡½æ•°ï¼š**åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œäº‹ä»¶å¤šæ¬¡è§¦å‘åªæ‰§è¡Œä¸€æ¬¡å›žè°ƒå‡½æ•°**ã€‚ä¸è®ºäº‹ä»¶è§¦å‘å¤šé¢‘ç¹ï¼Œéƒ½ä¼šæŒ‰ç…§å›ºå®šçš„æ—¶é—´é—´éš”æ‰§è¡Œã€‚

**ðŸ“š ç¤ºä¾‹ä»£ç **

:::code-group

```js
const throttle = (fn, wait) => {
  let lastTime = 0;
  let timer;

  return function (...args) {
    const context = this;
    const now = Date.now();

    // é—´éš”æ—¶é—´å¤§äºŽç­‰äºŽ waitï¼Œç›´æŽ¥æ‰§è¡Œ
    if (now - lastTime >= wait) {
      fn.apply(context, args);
      lastTime = now;
    } else {
      // å¦åˆ™æ›´æ–°å®šæ—¶å™¨
      clearTimeout(timer);
      timer = setTimeout(() => {
        fn.apply(context, args);
        lastTime = Date.now();
      }, wait - (now - lastTime));
    }
  };
};
```

```html [ä½¿ç”¨ç¤ºä¾‹]
<body>
  <div style="height: 200vh; background-color: lightblue"></div>
</body>

<script>
  const throttle = (fn, wait) => {
    // å®žçŽ°ç•¥...
  };

  const handleScroll = (e) => {
    console.log(e.target.scrollingElement.scrollTop);
  };

  const throttleHandleScroll = throttle(handleScroll, 1000);
  document.addEventListener("scroll", throttleHandleScroll);
</script>
```

:::

**ðŸŽ¨ åº”ç”¨åœºæ™¯**

- å›¾ç‰‡æ»šåŠ¨åŠ è½½ï¼šé¡µé¢æ»šåŠ¨æ—¶ï¼Œä¸æ–­æ‰§è¡Œå›¾ç‰‡åŠ è½½å‡½æ•°ã€‚ï¼ˆä¸ä½¿ç”¨é˜²æŠ–æ˜¯å› ä¸ºä¸å¯èƒ½ç­‰åˆ°ç”¨æˆ·åœæ­¢æ»šåŠ¨æ‰åŠ è½½å›¾ç‰‡å§ï¼ï¼‰
- æ‹–æ‹½ï¼ˆ`touchmove`ï¼‰äº‹ä»¶ï¼šæ‹–æ‹½å…ƒç´ æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­ä¸æ–­è®¡ç®—å…ƒç´ ä½ç½®ï¼Œä½†ä¸å¸Œæœ›è®¡ç®—è¿‡äºŽé¢‘ç¹ã€‚

## åœºæ™¯é¢˜

### å¹¶å‘è¯·æ±‚æŽ§åˆ¶

å®žçŽ°ä¸€ä¸ª `PromisePool` ç±»ï¼Œé™åˆ¶å¹¶å‘è¯·æ±‚çš„æ•°é‡ã€‚

```js
class PromisePool {
  constructor(capacity) {
    this.capacity = capacity;
    this.tasks = [];
    this.running = 0;
  }

  add(fn) {
    return new Promise((resolve, reject) => {
      this.tasks.push({
        fn,
        resolve,
        reject,
      });
      this._run();
    });
  }

  _run() {
    while (this.tasks.length && this.running < this.capacity) {
      const { fn, resolve, reject } = this.tasks.shift();
      this.running++;
      fn()
        .then(resolve, reject)
        .finally(() => {
          this.running--;
          this._run();
        });
    }
  }
}

const sleep = (time) => new Promise((resolve) => setTimeout(resolve, time));
const addTask = (time, str) => {
  pool
    .add(() => sleep(time))
    .then(() => {
      console.log(str);
    });
};
const pool = new PromisePool(2);
addTask(10000, "1");
addTask(5000, "2");
addTask(3000, "3");
addTask(4000, "4");
addTask(5000, "5");
// 2 3 1 4 5
```
